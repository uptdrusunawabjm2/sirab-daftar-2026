<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Dashboard Admin Pendaftaran</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>
<script src="config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script>
(async ()=>{

  const token = localStorage.getItem("RUSUN_TOKEN");
  if(!token){
    location.href="login";
    return;
  }

  const fd = new URLSearchParams();
  fd.append("action","cek_token");
  fd.append("token",token);

  const r = await fetch(CONFIG.API,{method:"POST",body:fd});
  const j = await r.json();

  if(!j.status){
    localStorage.removeItem("RUSUN_TOKEN");
    location.href="login";
  }
})();
</script>

<script>
function logout(){
  localStorage.removeItem("RUSUN_TOKEN");
  localStorage.removeItem("RUSUN_USER");
  location.href="login";
}
</script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
body{
  font-family: 'Inter', sans-serif;
  background:#f3f6fb;
  color:#1f2937;
}

/* GOVERNMENT CLEAN STYLE */
.card-clean{
  background:#ffffff;
  border:1px solid #e5e7eb;
  border-radius:12px;
  box-shadow:0 2px 6px rgba(0,0,0,0.05);
}

.input-clean{
  background:#ffffff;
  border:1px solid #d1d5db;
  border-radius:8px;
}

.btn-primary{
  background:#1e40af;
  color:white;
  border-radius:8px;
  transition:.2s;
}
.btn-primary:hover{
  background:#1e3a8a;
}

.btn-success{
  background:#059669;
  color:white;
  border-radius:8px;
}

.btn-danger{
  background:#dc2626;
  color:white;
  border-radius:8px;
}

.table-clean{
  background:white;
  border:1px solid #e5e7eb;
}

.table-clean th{
  background:#f3f4f6 !important;
  color:#374151;
  font-weight:600;
}

.table-clean td{
  color:#374151;
}

.sidebar-clean{
  background:#ffffff;
  border-right:1px solid #e5e7eb;
  color:#374151;
}

.header-clean{
  background:#1e40af;
  color:white;
  box-shadow:0 2px 8px rgba(0,0,0,0.08);
}
</style>

</head>

<body class="min-h-screen flex flex-col md:flex-row">

<!-- SIDEBAR -->
<div id="sidebar"
class="fixed md:relative z-40 w-64 h-full md:h-auto sidebar-clean flex flex-col transition-transform duration-300"

<div class="p-4 border-b border-slate-800">
<div class="text-xl font-bold">Admin Panel</div>
<div class="text-xs text-slate-400">Pendaftaran Rusunawa</div>
</div>

<div class="flex-1 p-4 space-y-2 text-sm">
<a class="block p-2 rounded bg-blue-100 text-blue-700 font-medium">Data Pendaftaran</a>
<a href="tracking" target="_blank" class="block p-2 rounded hhover:bg-gray-100">Tracking</a>
<a href="index" target="_blank" class="block p-2 rounded hover:bg-gray-100">Form Daftar</a>
</div>
</div>

<!-- MAIN -->
<div id="main" class="flex-1 flex flex-col transition-all duration-300">

<!-- HEADER -->
<div class="header-clean p-3 flex items-center gap-3 sticky top-0 z-30">
<button onclick="toggleSidebar()" class="bg-white/20 px-3 py-1 rounded">☰</button>
<button onclick="logout()" class="text-xs bg-red-500 px-2 py-1 rounded">Logout</button>
<div class="font-semibold flex-1 text-center">Dashboard Admin Pendaftaran</div>
<div class="text-xs text-slate-400">Realtime aktif</div>
</div>

<div class="p-4 space-y-4">

<!-- STATISTIK -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">

<div class="card-clean p-4">
<div class="text-slate-400 text-sm">Total Data</div>
<div id="rTotal" class="text-2xl font-bold">0</div>
</div>

<div class="card-clean p-4">
<div class="text-yellow-300 text-sm">Menunggu</div>
<div id="rPending" class="text-2xl font-bold text-yellow-400">0</div>
</div>

<div class="card-clean p-4">
<div class="text-green-300 text-sm">Diterima</div>
<div id="rAcc" class="text-2xl font-bold text-green-400">0</div>
</div>

<div class="card-clean p-4">
<div class="text-red-300 text-sm">Ditolak</div>
<div id="rReject" class="text-2xl font-bold text-red-400">0</div>
</div>

</div>

<!-- FILTER -->
<div class="flex flex-col md:flex-row gap-2">

  <input id="cari"
  placeholder="Cari nama / rusun / status"
  input-clean>

  <div class="flex gap-2 w-full md:w-auto">

    <select id="filterStatus"
    class="p-2 text-sm w-1/2 md:w-auto bg-slate-800 border border-slate-700 rounded">
      <option value="">Semua Status</option>
      <option value="MENUNGGU">MENUNGGU</option>
      <option value="VERIFIKASI">VERIFIKASI</option>
      <option value="DIPROSES">DIPROSES</option>
      <option value="DITERIMA">DITERIMA</option>
      <option value="DITOLAK">DITOLAK</option>
    </select>

    <select id="sortTanggal"
    class="p-2 text-sm w-1/2 md:w-auto bg-slate-800 border border-slate-700 rounded">
      <option value="desc">Tanggal Terbaru</option>
      <option value="asc">Tanggal Terlama</option>
    </select>

    <button onclick="exportXLSX()"
    class="btn-success px-3 py-2 text-sm">
      Export XLSX
    </button>

  </div>

</div>

<!-- PAGINATION -->
<div class="flex flex-wrap gap-2 items-center">
<select id="rowsPerPage" class="bg-slate-800 border border-slate-700 p-1 rounded">
<option value="10">10</option>
<option value="25" selected>25</option>
<option value="50">50</option>
<option value="100">100</option>
</select>

<button onclick="prevPage()" class="bg-slate-700 px-3 py-1 rounded">Prev</button>
<span id="pageInfo"></span>
<button onclick="nextPage()" class="bg-slate-700 px-3 py-1 rounded">Next</button>
</div>

<!-- TABLE -->
<div class="table-clean rounded-xl text-xs md:text-sm">
  <div class="table-wrap overflow-auto max-h-[70vh]">
    <table id="table" class="min-w-[1100px] border-collapse">
</table>
</div>

</div>
</div>

<!-- MODAL -->
<div id="modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center p-4 z-[9999]">
<div class="bg-white border border-gray-200 rounded-xl p-4 w-full max-w-md space-y-2 max-h-[90vh] overflow-auto">

<h2 class="font-bold">Update Verifikasi</h2>

<select id="mStatus" class="w-full p-2 rounded bg-slate-800 border border-slate-700">
<option>MENUNGGU</option>
<option>VERIFIKASI</option>
<option>DIPROSES</option>
<option>DITERIMA</option>
<option>DITOLAK</option>
</select>

<textarea id="mCatatan" class="w-full p-2 rounded bg-slate-800 border border-slate-700" placeholder="Catatan"></textarea>

<input type="date" id="mTanggal" class="w-full p-2 rounded bg-slate-800 border border-slate-700">

<input id="mNo" class="w-full p-2 rounded bg-slate-800 border border-slate-700" placeholder="No Pendaftaran">
<input id="mUnit" class="w-full p-2 rounded bg-slate-800 border border-slate-700" placeholder="Unit">

<div class="flex gap-2 pt-2">
<button onclick="simpan()" class="flex-1 bg-blue-600 p-2 rounded active:scale-95 transition">Simpan</button>
<button onclick="closeModal()" class="flex-1 bg-slate-700 p-2 rounded">Batal</button>
</div>

</div>
</div>

<script>
const API = CONFIG.API;
const KEY = CONFIG.INTERNAL_KEY;

let HEAD=[], DATA=[], RAW_DATA=[];
let page=1, rows=25, lastHash="", ROW=null;

/* TAMBAHAN ROLE */
const ROLE = localStorage.getItem("RUSUN_ROLE") || "admin";

/* LOAD */
async function load(){
  const r = await fetch(API+"?action=daftar_all&key="+KEY);
  const j = await r.json();

  const newHash = JSON.stringify(j.data);

  if(newHash!==lastHash){
    HEAD=j.header;
    RAW_DATA=j.data;       // simpan data asli
    DATA=[...RAW_DATA];    // data kerja
    lastHash=newHash;
    hitung();
    render();
}
}

/* STATISTIK */
function hitung(){
  const idx=HEAD.indexOf("Status Verifikasi");
  let p=0,a=0,rj=0;
  DATA.forEach(d=>{
    if(d[idx]==="DITERIMA") a++;
    else if(d[idx]==="DITOLAK") rj++;
    else p++;
  });
  rTotal.textContent=DATA.length;
  rPending.textContent=p;
  rAcc.textContent=a;
  rReject.textContent=rj;
}

/* TABLE */
function render(){

  rows=parseInt(rowsPerPage.value);

  const currentRows = parseInt(rowsPerPage.value);
  const maxPage = Math.max(1, Math.ceil(DATA.length / currentRows));
  if(page > maxPage) page = maxPage;

  const start=(page-1)*rows;
  const slice=DATA.slice(start,start+rows);

  let h="<thead><tr>";
  HEAD.forEach(c=>h+=`<th class='p-2 border'>${c}</th>`);
  h+="<th class='p-2 border'>Aksi</th></tr></thead>";

  h+="<tbody>";

  slice.forEach((r,i)=>{

    const idx=start+i;

    h+="<tr class='hover:bg-gray-100'>";

    r.forEach((v,ci)=>{

  // FORMAT KOLOM TANGGAL FORMULIR
  if(HEAD[ci]==="Tanggal Formulir" && v){

    const d = new Date(v);

    const bulan=[
      "Januari","Februari","Maret","April","Mei","Juni",
      "Juli","Agustus","September","Oktober","November","Desember"
    ];

    if(!isNaN(d)){
      v = d.getDate()+" "+bulan[d.getMonth()]+" "+d.getFullYear();
    }
  }

  h+=`<td class='p-2 border'>${v||""}</td>`;
});

    h+=`<td class='p-2 border space-x-1'>`;
    if(ROLE === "super"){
      h+=`
        <button onclick='openModal(${idx})'
          class='bg-blue-600 px-2 py-1 rounded text-xs'>
          Update
        </button>
      `;
    }

    h+=`
      <button onclick='lihatDetail(${idx})'
        class='bg-emerald-600 px-2 py-1 rounded text-xs'>
        Detail
      </button>
    </td>`;

    h+="</tr>";
  });

  h+="</tbody>";

  table.innerHTML=h;

  pageInfo.textContent=`Page ${page}/${maxPage} | Total ${DATA.length}`;
}

/* MODAL */
function openModal(i){

  ROW=i;

  const idxStatus = HEAD.indexOf("Status Verifikasi");
  const idxCatatan = HEAD.indexOf("Catatan Verifikasi");
  const idxTanggal = HEAD.indexOf("Tanggal Verifikasi");
  const idxNo = HEAD.indexOf("No Pendaftaran");

  let idxUnit = HEAD.indexOf("_unit");
  if(idxUnit===-1) idxUnit = HEAD.indexOf("Unit");

  /* ===== AMBIL DATA DARI DATABASE ===== */
  mStatus.value = DATA[i][idxStatus] || "MENUNGGU";
  mCatatan.value = DATA[i][idxCatatan] || "";

  /* FORMAT datetime-local */
  const tgl = DATA[i][idxTanggal];
  if(tgl){
    const d = new Date(tgl);
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    mTanggal.value = `${yyyy}-${mm}-${dd}`;
  }else{
    mTanggal.value = "";
  }

  mNo.value = DATA[i][idxNo] || "";
  mUnit.value = DATA[i][idxUnit] || "";

  modal.classList.remove("hidden");
  modal.classList.add("show");
}

function closeModal(){
  modal.classList.add("hidden");
  modal.classList.remove("show");
}

/* UPDATE */
async function simpan(){

  if(ROLE !== "super"){
    alert("Anda tidak memiliki hak akses untuk update.");
    return;
  }

  const noIdx = HEAD.indexOf("No Pendaftaran");
  const noLama = DATA[ROW][noIdx];

  try{

    const fd = new URLSearchParams();
    fd.append("action","daftar_update");
    fd.append("key",KEY);
    fd.append("no_lama",noLama);
    fd.append("status",mStatus.value);
    fd.append("catatan",mCatatan.value);
    fd.append("tanggal",mTanggal.value);
    fd.append("no_baru",mNo.value);
    fd.append("unit",mUnit.value);

    const r = await fetch(API,{
      method:"POST",
      body:fd
    });

    const j = await r.json();

    if(!j || j.status!==true){
      alert("Gagal update ke database!");
      return;
    }

    closeModal();
    await load();
    toast("Berhasil update data");

  }catch(err){
    alert("Koneksi gagal!");
  }
}

function nextPage(){

  rows = parseInt(rowsPerPage.value);   // ← WAJIB

  const currentRows = parseInt(rowsPerPage.value);
  const maxPage = Math.max(1, Math.ceil(DATA.length / currentRows));;

  if(page < maxPage){
    page++;
    render();
  }
}

function prevPage(){

  rows = parseInt(rowsPerPage.value);   // ← WAJIB

  if(page > 1){
    page--;
    render();
  }
}

function applyFilter(){

  const q = (cari.value||"").toLowerCase();
  const fs = filterStatus.value;
  const mode = sortTanggal.value;

  let filtered = RAW_DATA.filter(r=>{

    const idxStatus = HEAD.indexOf("Status Verifikasi");
    const idxNama   = HEAD.indexOf("Nama Pemohon");
    const idxRusun  = HEAD.indexOf("Rusunawa");

    if(fs && r[idxStatus]!==fs) return false;

    if(!q) return true;

    return (
      String(r[idxNama]||"").toLowerCase().includes(q) ||
      String(r[idxRusun]||"").toLowerCase().includes(q) ||
      String(r[idxStatus]||"").toLowerCase().includes(q)
    );
  });

  // SORT TANGGAL
  const idxTanggal = HEAD.indexOf("Tanggal Formulir");

  filtered.sort((a,b)=>{
    const ta = new Date(a[idxTanggal]||0).getTime();
    const tb = new Date(b[idxTanggal]||0).getTime();
    return mode==="asc" ? ta-tb : tb-ta;
  });

  DATA = filtered;
  page=1;
  render();
}

cari.oninput=applyFilter;
filterStatus.onchange=applyFilter;
sortTanggal.onchange=applyFilter;

rowsPerPage.onchange = ()=>{
  page = 1;
  render();
};

function toggleSidebar(){

  const sidebar = document.getElementById("sidebar");

  if(!sidebar) return;

  sidebar.classList.toggle("sidebar-hide");

}

function toast(msg,type="ok"){
  const t=document.createElement("div");
  t.className="fixed bottom-4 right-4 px-4 py-2 rounded shadow-lg z-50 text-sm "
    +(type==="ok"?"bg-green-600":"bg-red-600");
  t.textContent=msg;
  document.body.appendChild(t);
  setTimeout(()=>t.remove(),2500);
}

function exportXLSX(){

  if(!DATA.length){
    alert("Tidak ada data");
    return;
  }

  const idxTglForm = HEAD.indexOf("Tanggal Formulir");
  const idxTglVer  = HEAD.indexOf("Tanggal Verifikasi");
  const idxHP      = HEAD.indexOf("Nomor Telepon/HP/WA");

  const bulan=[
    "Januari","Februari","Maret","April","Mei","Juni",
    "Juli","Agustus","September","Oktober","November","Desember"
  ];

  const wsData=[HEAD];

  DATA.forEach(r=>{

    const row=[...r];

    // FORMAT TANGGAL FORMULIR
    if(row[idxTglForm]){
      const d=new Date(row[idxTglForm]);
      if(!isNaN(d)){
        row[idxTglForm]=
          d.getDate()+" "+bulan[d.getMonth()]+" "+d.getFullYear();
      }
    }

    // FORMAT TANGGAL VERIFIKASI
    if(row[idxTglVer]){
      const d=new Date(row[idxTglVer]);
      if(!isNaN(d)){
        row[idxTglVer]=
          d.getDate()+" "+bulan[d.getMonth()]+" "+d.getFullYear();
      }
    }

    // NOMOR HP → PAKSA JADI TEXT
    if(row[idxHP]){
      row[idxHP] = String(row[idxHP]);
    }

    wsData.push(row);
  });

  const ws = XLSX.utils.aoa_to_sheet(wsData);

  // PAKSA KOLOM HP JADI TEXT (ANTI SCIENTIFIC)
  if(idxHP !== -1){
    const range = XLSX.utils.decode_range(ws["!ref"]);
    for(let R = 1; R <= range.e.r; ++R){
      const cell = XLSX.utils.encode_cell({r:R, c:idxHP});
      if(ws[cell]){
        ws[cell].t = "s"; // set as string
      }
    }
  }

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Pendaftaran");

  XLSX.writeFile(wb, "Data_Pendaftaran.xlsx");
}

/* REALTIME VIA LONG-POLL */
async function realtime(){
  try{
    const r = await fetch(API+"?action=daftar_all&key="+KEY+"&t="+Date.now());
    const j = await r.json();

    const newHash = JSON.stringify(j.data);

    if(newHash !== lastHash){

    const oldPage = page;   // simpan halaman aktif

    HEAD=j.header;
    RAW_DATA=j.data;
    DATA=[...RAW_DATA];
    lastHash=newHash;
    hitung();

    const currentRows = parseInt(rowsPerPage.value);
    const maxPage = Math.max(1, Math.ceil(DATA.length / currentRows));
    if(oldPage <= maxPage){
      page = oldPage;       // kembali ke halaman sebelumnya
    }else{
      page = maxPage;       // jika page sudah tidak ada → pakai max
    }

    render();
}

  }catch(e){}

  setTimeout(realtime,2000);   // refresh 2 detik (lebih cepat & ringan)
}

let CURRENT_DETAIL=null;

function lihatDetail(i){

  CURRENT_DETAIL = DATA[i];

  let html="";
  HEAD.forEach((h,idx)=>{
    html+=`<div><strong>${h}</strong> : ${CURRENT_DETAIL[idx]||"-"}</div>`;
  });

  detailContent.innerHTML=html;

  modalDetail.classList.remove("hidden");
  modalDetail.classList.add("flex");
}

function closeDetail(){
  modalDetail.classList.add("hidden");
  modalDetail.classList.remove("flex");
}

function downloadPDF(){

  if(!CURRENT_DETAIL) return;

  const win = window.open("", "_blank");

  let html = `
  <html>
  <head>
    <title>Detail Pendaftaran</title>
    <style>
      body{font-family:Arial;padding:30px}
      h2{text-align:center}
      table{width:100%;border-collapse:collapse}
      td{border:1px solid #ccc;padding:6px;font-size:12px}
      td:first-child{font-weight:bold;width:40%}
    </style>
  </head>
  <body>
    <h2>Detail Pendaftaran Rusunawa</h2>
    <table>
  `;

  HEAD.forEach((h,idx)=>{
    html+=`<tr><td>${h}</td><td>${CURRENT_DETAIL[idx]||"-"}</td></tr>`;
  });

  html+=`</table></body></html>`;

  win.document.write(html);
  win.document.close();
  setTimeout(()=>win.print(),300);
}

(async ()=>{
  await load();
  realtime();
})();

</script>
<div id="modalDetail" class="fixed inset-0 bg-black/70 hidden items-center justify-center p-4 z-[9999]">
  <div class="bg-white text-black rounded-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-auto">

    <div class="flex justify-between items-center mb-4">
      <h2 class="font-bold text-lg">Detail Pendaftaran</h2>
      <button onclick="closeDetail()" class="text-red-600 font-bold">X</button>
    </div>

    <div id="detailContent" class="text-sm space-y-1"></div>

    <div class="mt-4 flex gap-2">
      <button onclick="downloadPDF()" class="bg-blue-600 text-white px-4 py-2 rounded">
        Download PDF
      </button>
    </div>

  </div>
</div>
</body>
</html>
