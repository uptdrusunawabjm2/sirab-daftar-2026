<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Admin Pendaftaran</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>
<script src="config.js"></script>
</head>

<body class="bg-slate-950 text-white min-h-screen flex">

<div id="sidebar"
class="w-64 bg-slate-900 border-r border-slate-800 flex flex-col">

<div class="p-4 border-b border-slate-800">
<div class="text-xl font-bold">Admin Panel</div>
<div class="text-xs text-slate-400">Pendaftaran Rusunawa</div>
</div>

<div class="flex-1 p-4 space-y-2 text-sm">
<a class="block p-2 rounded bg-slate-800">üìã Data Pendaftaran</a>
<a href="tracking.html" target="_blank" class="block p-2 rounded hover:bg-slate-800">üîé Tracking</a>
<a href="index.html" target="_blank" class="block p-2 rounded hover:bg-slate-800">üìù Form</a>
</div>

<div class="p-4 border-t border-slate-800">
<button onclick="logout()"
class="w-full bg-red-600/20 border border-red-600 text-red-400 px-3 py-2 rounded">
Logout
</button>
</div>
</div>

<div class="flex-1 flex flex-col">

<div class="bg-slate-900 border-b border-slate-800 p-3 text-center font-semibold">
Dashboard Admin Pendaftaran
</div>

<div class="p-4 space-y-4">

<div class="grid grid-cols-2 md:grid-cols-5 gap-3">
<div class="card">Total<br><b id="rTotal">0</b></div>
<div class="card">Menunggu<br><b id="rPending">0</b></div>
<div class="card">Diterima<br><b id="rOk">0</b></div>
<div class="card">Ditolak<br><b id="rNo">0</b></div>
<div class="card">Waiting<br><b id="rWait">0</b></div>
</div>

<div class="bg-slate-900 border border-slate-800 rounded-xl overflow-auto max-h-[70vh]">
<table class="w-full text-sm" id="table"></table>
</div>

</div>
</div>

<div id="modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center">
<div class="bg-slate-900 border border-slate-800 rounded-xl p-4 w-full max-w-md">

<h2 class="font-bold mb-2">Update Verifikasi</h2>

<select id="mStatus" class="w-full p-2 rounded bg-slate-800 border border-slate-700 mb-2">
<option>MENUNGGU</option>
<option>DITERIMA</option>
<option>DITOLAK</option>
<option>WAITING</option>
</select>

<textarea id="mCatatan"
class="w-full p-2 rounded bg-slate-800 border border-slate-700 mb-2"
placeholder="Catatan Verifikasi"></textarea>

<label class="text-xs">Tanggal Verifikasi</label>
<input type="datetime-local" id="mTanggal"
class="w-full p-2 rounded bg-slate-800 border border-slate-700 mb-2">

<label class="text-xs">No Pendaftaran</label>
<input id="mNo"
class="w-full p-2 rounded bg-slate-800 border border-slate-700 mb-2">

<label class="text-xs">Unit</label>
<input id="mUnit"
class="w-full p-2 rounded bg-slate-800 border border-slate-700 mb-2">

<div class="flex gap-2">
<button onclick="simpan()" class="flex-1 bg-blue-600 p-2 rounded">Simpan</button>
<button onclick="closeModal()" class="flex-1 bg-slate-700 p-2 rounded">Batal</button>
</div>

</div>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbySr6QhyH72b4aAU6Xv6mltljm_ft07ysWb40J45QivoXYix8Xh9M1kJ8zLe4PzQ5i8/exec";
const KEY = "rusun2026";

let HEAD=[], DATA=[], ROW=null;

load();

async function load(){
  const r = await fetch(API+"?action=daftar_all&key="+KEY);
  const j = await r.json();
  HEAD=j.header;
  DATA=j.data;
  render();
  stat();
}

function render(){
  let h="<tr class='bg-slate-800 sticky top-0'>";
  HEAD.forEach(c=>h+=`<th class="p-2 border border-slate-700">${c}</th>`);
  h+="<th class='p-2 border'>Aksi</th></tr>";

  DATA.forEach((r,i)=>{
    h+="<tr class='hover:bg-slate-800'>";
    HEAD.forEach((c,x)=>{
      let v=r[x]||"";
      if(c==="Status Verifikasi") v=badge(v);
      h+=`<td class="p-2 border border-slate-800">${v}</td>`;
    });
    h+=`<td class="p-2 border border-slate-800">
    <button onclick="openModal(${i})"
    class="bg-blue-600 px-2 py-1 rounded text-xs">Update</button></td></tr>`;
  });

  table.innerHTML=h;
}

function badge(s){
  s=(s||"").toUpperCase();
  if(s.includes("DITERIMA")) return `<span class="text-green-400">DITERIMA</span>`;
  if(s.includes("DITOLAK")) return `<span class="text-red-400">DITOLAK</span>`;
  if(s.includes("WAIT")) return `<span class="text-purple-400">WAITING</span>`;
  return `<span class="text-yellow-400">MENUNGGU</span>`;
}

function openModal(i){
  ROW=i;

  const idxStatus = HEAD.indexOf("Status Verifikasi");
  const idxCat = HEAD.indexOf("Catatan Verifikasi");
  const idxTgl = HEAD.indexOf("Tanggal Verifikasi");
  const idxNo = HEAD.indexOf("No Pendaftaran");
  const idxUnit = HEAD.indexOf("_unit");

  mStatus.value = DATA[i][idxStatus] || "MENUNGGU";
  mCatatan.value = DATA[i][idxCat] || "";
  mNo.value = DATA[i][idxNo] || "";
  mUnit.value = DATA[i][idxUnit] || "";

  if(DATA[i][idxTgl]){
    const d=new Date(DATA[i][idxTgl]);
    mTanggal.value = d.toISOString().slice(0,16);
  }else{
    mTanggal.value="";
  }

  modal.classList.remove("hidden");
}

function closeModal(){
  modal.classList.add("hidden");
}

async function simpan(){

  const noIdx=HEAD.indexOf("No Pendaftaran");
  const noLama=DATA[ROW][noIdx];

  await fetch(API,{
    method:"POST",
    body:JSON.stringify({
      action:"daftar_update",
      key:KEY,
      no_lama:noLama,
      status:mStatus.value,
      catatan:mCatatan.value,
      tanggal:mTanggal.value,
      no_baru:mNo.value,
      unit:mUnit.value
    })
  });

  closeModal();
  load();
}

function stat(){
  let t=DATA.length,p=0,o=0,n=0,w=0;
  const i=HEAD.indexOf("Status Verifikasi");
  DATA.forEach(r=>{
    const s=(r[i]||"").toUpperCase();
    if(s.includes("DITERIMA")) o++;
    else if(s.includes("DITOLAK")) n++;
    else if(s.includes("WAIT")) w++;
    else p++;
  });
  rTotal.innerText=t;
  rPending.innerText=p;
  rOk.innerText=o;
  rNo.innerText=n;
  rWait.innerText=w;
}

function logout(){
  sessionStorage.clear();
  location.href="login.html";
}
</script>

<style>
.card{
background:#020617;
border:1px solid #1e293b;
padding:10px;
border-radius:10px;
text-align:center;
}
</style>

</body>
</html>
