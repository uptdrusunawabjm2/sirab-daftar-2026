<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Dashboard Admin Pendaftaran</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>
<script src="config.js"></script>
<script>
(async ()=>{

  const token = localStorage.getItem("RUSUN_TOKEN");
  if(!token){
    location.href="login.html";
    return;
  }

  const fd = new URLSearchParams();
  fd.append("action","cek_token");
  fd.append("token",token);

  const r = await fetch(CONFIG.API,{method:"POST",body:fd});
  const j = await r.json();

  if(!j.status){
    localStorage.removeItem("RUSUN_TOKEN");
    location.href="login.html";
  }
})();
</script>

<script>
function logout(){
  localStorage.removeItem("RUSUN_TOKEN");
  localStorage.removeItem("RUSUN_USER");
  location.href="login.html";
}
</script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
body{
  font-family: 'Inter', sans-serif;
  background:#0b1220;
}

/* SCROLL SMOOTH */
*{scroll-behavior:smooth}

/* SIDEBAR */
.sidebar{
  transition:all .25s ease;
}

/* MOBILE SIDEBAR */
@media(max-width:900px){
  .sidebar{
    position:fixed;
    left:-260px;
    top:0;
    height:100%;
    z-index:50;
  }
  .sidebar.show{
    left:0;
  }
}

/* TABLE SWIPE MOBILE */
.table-wrap{
  overflow-x:auto;
  -webkit-overflow-scrolling:touch;
}

/* STICKY HEADER */
.sticky-top{
  position:sticky;
  top:0;
  z-index:30;
  backdrop-filter:blur(6px);
}

/* STICKY TABLE HEAD */
thead th{
  position:sticky;
  top:60px;
  z-index:20;
}

/* MODAL SMOOTH */
.modal{
  transition:all .18s ease;
}
.modal.show{
  opacity:1;
  transform:scale(1);
}
.modal.hide{
  opacity:0;
  transform:scale(.95);
}

@media(max-width:768px){

  body{
    flex-direction:column;
  }

  #sidebar{
    position:relative;
    top:0;
    left:0;
    height:100%;
    width:260px;
    z-index:50;
  }

  main{
    width:100%;
    padding:10px;
  }

  table{
    font-size:12px;
  }

  th,td{
    padding:8px;
    white-space:nowrap;
  }
}

/* DESKTOP COLLAPSE */
.sidebar.collapsed{
  transform:translateX(-100%);
}

</style>

</head>

<body class="bg-slate-950 text-white min-h-screen flex flex-col md:flex-row">

<!-- SIDEBAR -->
<div id="sidebar"
class="fixed md:relative z-40 w-64 h-full md:h-auto bg-slate-900 border-r border-slate-800 flex flex-col transition-transform duration-300">

<div class="p-4 border-b border-slate-800">
<div class="text-xl font-bold">Admin Panel</div>
<div class="text-xs text-slate-400">Pendaftaran Rusunawa</div>
</div>

<div class="flex-1 p-4 space-y-2 text-sm">
<a class="block p-2 rounded bg-slate-800">üìã Data Pendaftaran</a>
<a href="tracking.html" target="_blank" class="block p-2 rounded hover:bg-slate-800">üîé Tracking</a>
<a href="index.html" target="_blank" class="block p-2 rounded hover:bg-slate-800">üìù Form</a>
</div>
</div>

<!-- MAIN -->
<div id="main" class="flex-1 flex flex-col transition-all duration-300">

<!-- HEADER -->
<div class="bg-slate-900 border-b border-slate-800 p-3 flex items-center gap-3 sticky top-0 z-30">
<button onclick="toggleSidebar()" class="bg-slate-800 px-3 py-1 rounded">‚ò∞</button>
<button onclick="logout()" class="text-xs bg-red-600 px-2 py-1 rounded">Logout</button>
<div class="font-semibold flex-1 text-center">Dashboard Admin Pendaftaran</div>
<div class="text-xs text-slate-400">Realtime aktif</div>
</div>

<div class="p-4 space-y-4">

<!-- STATISTIK -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">

<div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
<div class="text-slate-400 text-sm">Total Data</div>
<div id="rTotal" class="text-2xl font-bold">0</div>
</div>

<div class="bg-yellow-500/20 border border-yellow-500 rounded-xl p-4">
<div class="text-yellow-300 text-sm">Menunggu</div>
<div id="rPending" class="text-2xl font-bold text-yellow-400">0</div>
</div>

<div class="bg-green-600/20 border border-green-600 rounded-xl p-4">
<div class="text-green-300 text-sm">Diterima</div>
<div id="rAcc" class="text-2xl font-bold text-green-400">0</div>
</div>

<div class="bg-red-600/20 border border-red-600 rounded-xl p-4">
<div class="text-red-300 text-sm">Ditolak</div>
<div id="rReject" class="text-2xl font-bold text-red-400">0</div>
</div>

</div>

<!-- PAGINATION -->
<div class="flex flex-wrap gap-2 items-center">
<select id="rowsPerPage" class="bg-slate-800 border border-slate-700 p-1 rounded">
<option value="10">10</option>
<option value="25" selected>25</option>
<option value="50">50</option>
<option value="100">100</option>
</select>

<button onclick="prevPage()" class="bg-slate-700 px-3 py-1 rounded">Prev</button>
<span id="pageInfo"></span>
<button onclick="nextPage()" class="bg-slate-700 px-3 py-1 rounded">Next</button>
</div>

<!-- TABLE -->
<div class="bg-slate-900 border border-slate-800 rounded-xl overflow-auto max-h-[70vh] text-xs md:text-sm">
<div class="table-wrap">
<table id="table" class="min-w-[1100px]">
</table>
</div>

</div>
</div>

<!-- MODAL -->
<div id="modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center p-4">
<div class="bg-slate-900 border border-slate-800 rounded-xl p-4 w-full max-w-md space-y-2 max-h-[90vh] overflow-auto">

<h2 class="font-bold">Update Verifikasi</h2>

<select id="mStatus" class="w-full p-2 rounded bg-slate-800 border border-slate-700">
<option>MENUNGGU</option>
<option>VERIFIKASI</option>
<option>DIPROSES</option>
<option>DITERIMA</option>
<option>DITOLAK</option>
</select>

<textarea id="mCatatan" class="w-full p-2 rounded bg-slate-800 border border-slate-700" placeholder="Catatan"></textarea>

<input type="datetime-local" id="mTanggal" class="w-full p-2 rounded bg-slate-800 border border-slate-700">

<input id="mNo" class="w-full p-2 rounded bg-slate-800 border border-slate-700" placeholder="No Pendaftaran">
<input id="mUnit" class="w-full p-2 rounded bg-slate-800 border border-slate-700" placeholder="Unit">

<div class="flex gap-2 pt-2">
<button onclick="simpan()" class="flex-1 bg-blue-600 p-2 rounded active:scale-95 transition">Simpan</button>
<button onclick="closeModal()" class="flex-1 bg-slate-700 p-2 rounded">Batal</button>
</div>

</div>
</div>

<script>
const API = CONFIG.API;
const KEY = CONFIG.INTERNAL_KEY;

let HEAD=[], DATA=[];
let page=1, rows=25, lastHash="", ROW=null;

/* LOAD */
async function load(){
  const r = await fetch(API+"?action=daftar_all&key="+KEY);
  const j = await r.json();

  const newHash = j.data.length + "_" + (j.data[0]?.join("|")||"");

  if(newHash!==lastHash){
    HEAD=j.header;
    DATA=j.data;
    lastHash=newHash;
    hitung();
    render();
  }
}

/* STATISTIK */
function hitung(){
  const idx=HEAD.indexOf("Status Verifikasi");
  let p=0,a=0,rj=0;
  DATA.forEach(d=>{
    if(d[idx]==="DITERIMA") a++;
    else if(d[idx]==="DITOLAK") rj++;
    else p++;
  });
  rTotal.textContent=DATA.length;
  rPending.textContent=p;
  rAcc.textContent=a;
  rReject.textContent=rj;
}

/* TABLE */
function render(){
  rows=parseInt(rowsPerPage.value);
  const start=(page-1)*rows;
  const slice=DATA.slice(start,start+rows);

  let h="<tr class='bg-slate-800 sticky top-0'>";
  HEAD.forEach(c=>h+=`<th class='p-2 border'>${c}</th>`);
  h+="<th class='p-2 border'>Aksi</th></tr>";

  slice.forEach((r,i)=>{
    h+="<tr class='hover:bg-slate-800'>";
    r.forEach(v=>h+=`<td class='p-2 border'>${v||""}</td>`);
    h+=`<td class='p-2 border'><button onclick='openModal(${start+i})' class='bg-blue-600 px-2 py-1 rounded text-xs'>Update</button></td></tr>`;
  });

  table.innerHTML=h;
  pageInfo.textContent=`Page ${page} | Total ${DATA.length}`;
}

/* MODAL */
function openModal(i){

  ROW=i;

  const idxStatus = HEAD.indexOf("Status Verifikasi");
  const idxCatatan = HEAD.indexOf("Catatan Verifikasi");
  const idxTanggal = HEAD.indexOf("Tanggal Verifikasi");
  const idxNo = HEAD.indexOf("No Pendaftaran");

  let idxUnit = HEAD.indexOf("_unit");
  if(idxUnit===-1) idxUnit = HEAD.indexOf("Unit");

  /* ===== AMBIL DATA DARI DATABASE ===== */
  mStatus.value = DATA[i][idxStatus] || "MENUNGGU";
  mCatatan.value = DATA[i][idxCatatan] || "";

  /* FORMAT datetime-local */
  const tgl = DATA[i][idxTanggal];
  if(tgl){
    const d = new Date(tgl);
    const iso = d.toISOString().slice(0,16);
    mTanggal.value = iso;
  }else{
    mTanggal.value = "";
  }

  mNo.value = DATA[i][idxNo] || "";
  mUnit.value = DATA[i][idxUnit] || "";

  modal.classList.remove("hidden");
  modal.classList.add("show");
}

function closeModal(){
  modal.classList.add("hidden");
  modal.classList.remove("show");
}

/* UPDATE */
async function simpan(){

  const noIdx = HEAD.indexOf("No Pendaftaran");
  const noLama = DATA[ROW][noIdx];

  try{

    const fd = new URLSearchParams();
    fd.append("action","daftar_update");
    fd.append("key",KEY);
    fd.append("no_lama",noLama);
    fd.append("status",mStatus.value);
    fd.append("catatan",mCatatan.value);
    fd.append("tanggal",mTanggal.value);
    fd.append("no_baru",mNo.value);
    fd.append("unit",mUnit.value);

    const r = await fetch(API,{
      method:"POST",
      body:fd
    });

    const j = await r.json();

    if(!j || j.status!==true){
      alert("Gagal update ke database!");
      return;
    }

    closeModal();
    await load();

  }catch(err){
    alert("Koneksi gagal!");
  }
}

function nextPage(){page++;render();}
function prevPage(){if(page>1)page--;render();}
rowsPerPage.onchange=()=>{page=1;render();};

function toggleSidebar(){

  const s = document.getElementById("sidebar");
  const m = document.getElementById("main");

  if(!s || !m) return;

  // DESKTOP COLLAPSE
  if(window.innerWidth >= 900){

    if(s.classList.contains("collapsed")){
      s.classList.remove("collapsed");
      m.style.marginLeft = "16rem";
    }else{
      s.classList.add("collapsed");
      m.style.marginLeft = "0";
    }

  }
  // MOBILE OVERLAY
  else{
    s.classList.toggle("show");
  }
}

load();
setInterval(load,5000);
</script>

</body>
</html>
