<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Pendaftaran Rusunawa</title>
<script src="https://cdn.tailwindcss.com"></script>

<script>
/* === PATCH: wajib baca box + auto scroll error === */
let pasalSudahDibaca=false;

/* override togglePasal */
const _togglePasal_original = typeof togglePasal === "function" ? togglePasal : null;
togglePasal = function(){
  document.querySelectorAll(".pasalItem").forEach(box=>box.classList.toggle("hidden"));
  pasalSudahDibaca=true;
  if(typeof checkAgree==="function") checkAgree();
};

/* override checkAgree */
const _checkAgree_original = typeof checkAgree === "function" ? checkAgree : null;
checkAgree = function(){
  btnIntroNext.disabled = !(agree1.checked && agree2.checked && pasalSudahDibaca);
};

</script>

<style>
.input{
width:100%;
background:#1e293b;
border:1px solid #334155;
border-radius:12px;
padding:10px;
}
#formWrapper{display:none;}
/* honeypot bot */
.hp{display:none;}
</style>


<script>
/* === PATCH: focus + error highlight === */
.input:focus{
outline:none;
box-shadow:0 0 0 2px #3b82f6;
}
.err{
box-shadow:0 0 0 2px #ef4444 !important;
}
</script>

<script src="https://www.google.com/recaptcha/api.js?render=6LctlGQsAAAAANCxu-nYP1AxckjL--7GeEC_WE8r"></script>

</head>

<body class="bg-gray-950 text-gray-100 min-h-screen">

<div class="max-w-3xl mx-auto p-6">

<!-- ================= INTRO ================= -->
<div id="introPage"
class="bg-gradient-to-b from-slate-900 to-slate-950 border border-slate-800
rounded-3xl shadow-2xl p-8 mb-6 max-w-2xl mx-auto">

<h1 class="text-2xl font-semibold text-center mb-4">
Permohonan Penghunian Rusunawa
</h1>

<p class="text-center text-slate-300 text-sm">
Dengan mengisi formulir ini anda menyatakan setuju seluruh ketentuan.
</p>

<hr class="my-6 border-slate-700">

<div class="mt-6 bg-blue-600/80 border border-blue-400/30 rounded-2xl p-5 space-y-3">

<label class="flex gap-3">
<input type="checkbox" id="agree1">
<span>Saya memahami tujuan pengumpulan data</span>
</label>

<label class="flex gap-3">
<input type="checkbox" id="agree2">
<span>Saya menyetujui seluruh ketentuan Peraturan Wali Kota Banjarmasin Nomor 149 Tahun 2023</span>
</label>

<a href="javascript:void(0)"
onclick="togglePasal()"
class="text-xs underline opacity-90 hover:opacity-100 block text-center">
Baca pernyataan lengkap
</a>
<!-- ===== BOX 1 ===== -->
<div class="pasalItem hidden mt-3 bg-slate-900/60 border border-slate-700 rounded-xl p-4 text-sm text-slate-200">

<h3 class="text-left font-semibold mb-3">Informasi:</h3>

<ol class="list-[lower-alpha] pl-5 space-y-1 text-justify leading-relaxed max-w-md mx-auto">
<li>pengumpulan data melalui formulir ini dimaksudkan untuk memudahkan Pemohon dalam melengkapi persyaratan.</li>
<li>data yang dikumpulkan selanjutnya akan digunakan untuk keperluan pengumpulan, pengolahan, dan penganalisisan terbatas sebagai bagian dari proses verifikasi awal.</li>
</ol>
</div>

<!-- ===== BOX 2 ===== -->
<div class="pasalItem hidden mt-3 bg-slate-900/60 border border-slate-700 rounded-xl p-4 text-sm text-slate-200">

<h3 class="text-left font-semibold mb-3">Persyaratan:</h3>

<ol class="list-[lower-alpha] pl-5 space-y-1 text-justify leading-relaxed max-w-md mx-auto">
<li>Penghasilan maksimal 2x UMP.</li>
<li>Memiliki identitas kependudukan.</li>
<li>Sudah berkeluarga/menikah.</li>
<li>Anggota keluarga maksimal 4 orang.</li>
<li>Belum memiliki rumah/tempat tinggal sendiri.</li>
<li>Sanggup membayar sewa dan biaya lainnya.</li>
</ol>
</div>

<!-- ===== BOX 3 BARU ===== -->
<div class="pasalItem hidden mt-3 bg-slate-900/60 border border-slate-700 rounded-xl p-4 text-sm text-slate-200">

<h3 class="text-left font-semibold mb-3">Tata Tertib:</h3>

<ol class="list-[lower-alpha] pl-5 space-y-1 text-justify leading-relaxed max-w-md mx-auto">
<li>Sarusunawa hanya diperkenankan dihuni maksimal 4 (Empat) orang.</li>
<li>Penghuni wajib melapor kepada RT/RW dan/atau petugas keamanan apabila ada tamu yang akan bermalam lebih dari 1 x 24 jam.</li>
<li>Menjaga kebersihan, kerapihan, keamanan, dan keindahan Sarusunawa dan lingkungan Rusunawa.</li>
<li>Menjaga toleransi dan memelihara ikatan sosial yang baik sesama Penghuni.</li>
<li>Mematikan listrik, air, dan gas rumah tangga saat meninggalkan Sarusunawa.</li>
<li>Pemeliharaan dan perawatan Sarusunawa yang dilakukan oleh Penghuni wajib dilaporkan kepada UPTD.</li>
<li>Menempatkan kendaraan bermotor pada tempat parkir/lokasi yang telah ditetapkan UPTD.</li>
</ol>
</div>

<button id="btnIntroNext" disabled
class="w-full bg-blue-500 py-3 rounded-xl font-semibold">
Selanjutnya
</button>

</div>
</div>

<!-- ================= FORM ================= -->
<div id="formWrapper">

<h1 class="text-3xl font-bold mb-6 text-center">
Pendaftaran Calon Penghuni Rusunawa
</h1>

<div class="bg-slate-900 border border-slate-800 rounded-2xl shadow-xl p-6">

<div id="pages">

<!-- PAGE 1 -->
<div class="page space-y-4">
<label>Tanggal Formulir</label>
<label class="block text-slate-300 text-sm mb-1">Tanggal Formulir</label>
<input id="Tanggal Formulir" type="date" class="input">

<!-- honeypot bot -->
<input class="hp" id="website" name="company"
autocomplete="new-password"
tabindex="-1"
style="position:absolute;left:-9999px;">

</div>

<!-- PAGE 2 -->
<div class="page hidden space-y-3">
<label class="block text-slate-300 text-sm mb-1">Nama Pemohon</label>
<input id="Nama Pemohon" placeholder="Nama Pemohon" class="input">
<label class="block text-slate-300 text-sm mb-1">NIK Pemohon</label>
<input id="NIK Pemohon" inputmode="numeric" pattern="[0-9]*" placeholder="Nomor Handphone" class="input">
<p class="text-xs text-slate-400 mt-1">untuk sementara masukan no handphone"</p>
<label class="block text-slate-300 text-sm mb-1">Status Kependudukan</label>
<select id="Status Kependudukan" class="input">
<option value="">Status Kependudukan</option>
<option>Kota Banjarmasin</option>
<option>Penduduk Non Permanen</option>
</select>
<label class="block text-slate-300 text-sm mb-1">Umur</label>
<input id="Umur" inputmode="numeric" pattern="[0-9]*" placeholder="Umur" class="input">

<label class="block text-slate-300 text-sm mb-1">Alamat Sekarang</label>
<textarea id="Alamat sekarang" placeholder="Jalan... RT/RW... Kelurahan... Kab/Kota..." class="input"></textarea>

<label class="block text-slate-300 text-sm mb-1">Nomor Telepon / HP / WA</label>
<input id="Nomor Telepon/HP/WA" inputmode="numeric" pattern="[0-9]*" placeholder="Nomor Telepon (wa aktif)" class="input">
<label class="block text-slate-300 text-sm mb-1">Email</label>
<input id="Email" placeholder="Email" class="input">
</div>

<!-- PAGE 3 -->
<div class="page hidden space-y-4">
<label class="block text-slate-300 text-sm mb-1">Pekerjaan Pemohon</label>
<input id="Pekerjaan Pemohon" placeholder="Pekerjaan Pemohon" class="input">
<label class="block text-slate-300 text-sm mb-1">Nama Perusahaan / Tempat Kerja</label>
<input id="Nama Perusahaan/Tempat Kerja" placeholder="Nama Perusahaan/Tempat Kerja" class="input">
<label class="block text-slate-300 text-sm mb-1">Alamat Tempat Kerja</label>
<input id="Alamat Pekerjaan" placeholder="Alamat Tempat Kerja" class="input">
<p class="text-xs text-slate-400 mt-1">Jalan... No.Telp... Kab/Kota..."</p>
<label class="block text-slate-300 text-sm mb-1">Penghasilan Perbulan</label>
<input id="Penghasilan perbulan" inputmode="numeric" pattern="[0-9]*" placeholder="Penghasilan" class="input">
<label class="block text-slate-300 text-sm mb-1">Pekerjaan Pasangan</label>
<input id="Pekerjaan Pasangan" placeholder="Pekerjaan Pasangan" class="input">
<p class="text-xs text-slate-400 mt-1">jika tidak bekerja tulis "mengurus rumah tangga"</p>
<label class="block text-slate-300 text-sm mb-1">Nama Perusahaan / Tempat Kerja Pasangan</label>
<input id="Nama Perusahaan/Tempat Kerja 2" placeholder="Nama Perusahaan/Tempat Kerja Pasangan" class="input">
<label class="block text-slate-300 text-sm mb-1">Alamat Tempat Kerja Pasangan</label>
<input id="Alamat Pekerjaan Pasangan" placeholder="Alamat Tempat Kerja Pasangan" class="input">
<p class="text-xs text-slate-400 mt-1">Jalan... No.Telp... Kab/Kota..."</p>
<label class="block text-slate-300 text-sm mb-1">Penghasilan Perbulan Pasangan</label>
<input id="Penghasilan perbulan Pasangan" inputmode="numeric" pattern="[0-9]*" placeholder="Penghasilan perbulan Pasangan" class="input">
</div>

<!-- PAGE 4 -->
<div class="page hidden space-y-5">
<label class="block text-slate-300 text-sm mb-1">Nama Penjamin</label>
<input id="Nama Penjamin" placeholder="Nama Penjamin" class="input">
<label class="block text-slate-300 text-sm mb-1">Alamat Penjamin</label>
<input id="Alamat Penjamin" placeholder="Alamat Penjamin" class="input">
<p class="text-xs text-slate-400 mt-1">Penjamin wajib domisili di Kota Banjarmasin</p>
<label class="block text-slate-300 text-sm mb-1">Pekerjaan Penjamin</label>
<input id="Pekerjaan Penjamin" placeholder="Pekerjaan Penjamin" class="input">
<label class="block text-slate-300 text-sm mb-1">Status Hubungan dengan Pemohon</label>
<input id="Status Hubungan dengan Pemohon" placeholder="Status Hubungan dengan Pemohon" class="input">
</div>
  
<!-- PAGE 5 -->
<div class="page hidden space-y-4">
<label class="block text-slate-300 text-sm mb-1">Rusunawa</label>
<select id="Rusunawa">
</select>
<label class="block text-slate-300 text-sm mb-1">Tipe Kamar</label>
<select id="Tipe Kamar">
</select>
<label class="block text-slate-300 text-sm mb-1">Lantai</label>
<select id="Lantai">
</select>
</div>
  
</div>

<div class="flex justify-between mt-6">
<button onclick="prevPage()" id="prev"
class="bg-slate-700 px-5 py-2 rounded-xl">Kembali</button>

<button onclick="nextPage()" id="next"
class="bg-blue-600 px-5 py-2 rounded-xl font-bold">Lanjut</button>
</div>

<div id="msg" class="text-center mt-4 text-sm"></div>

</div>
</div>
</div>

<script>
const URL="https://script.google.com/macros/s/AKfycbySr6QhyH72b4aAU6Xv6mltljm_ft07ysWb40J45QivoXYix8Xh9M1kJ8zLe4PzQ5i8/exec";

let page=0;
let lastSubmit=0;
const pages=document.querySelectorAll(".page");
const msg=document.getElementById("msg");

/* VARIABLE LOCK UNIT */
let _unit="";
let _token="";

/* ===== AUTO LOAD DROPDOWN DARI GAP ===== */

const selRusun=document.getElementById("Rusunawa");
const selTipe=document.getElementById("Tipe Kamar");
const selLantai=document.getElementById("Lantai");

let GAP_DATA={};

document.addEventListener("DOMContentLoaded",loadOptions);

async function loadOptions(){

  try{

    const r=await fetch(URL+"?action=options");
    const j=await r.json();

    if(!j.status) throw "Gagal load";

    GAP_DATA=j.data;

    selRusun.innerHTML='<option value="">Pilih Rusunawa</option>';

    Object.keys(GAP_DATA).forEach(rusun=>{
      selRusun.innerHTML+=`<option value="${rusun}">${rusun}</option>`;
    });

  }catch{
    msg.className="text-red-400";
    msg.innerText="Gagal memuat daftar unit";
  }
}

/* RUSUN → TIPE */
selRusun.onchange=()=>{
  const rusun=selRusun.value;
  selTipe.innerHTML='<option value="">Pilih Tipe</option>';
  selLantai.innerHTML='<option value="">Pilih Lantai</option>';

  if(!rusun) return;

  Object.keys(GAP_DATA[rusun]).forEach(tipe=>{
    selTipe.innerHTML+=`<option value="${tipe}">${tipe}</option>`;
  });

  cekUnit();
};

/* TIPE → LANTAI */
selTipe.onchange=()=>{
  const rusun=selRusun.value;
  const tipe=selTipe.value;

  selLantai.innerHTML='<option value="">Pilih Lantai</option>';
  if(!rusun||!tipe) return;

  GAP_DATA[rusun][tipe].forEach(l=>{
    selLantai.innerHTML+=`<option value="${l}">${l}</option>`;
  });

  cekUnit();
};

/* LANTAI → CEK UNIT */
selLantai.onchange=cekUnit;

async function cekUnit(){

  const rusun=document.getElementById("Rusunawa").value;
  const tipe=document.getElementById("Tipe Kamar").value;
  const lantai=document.getElementById("Lantai").value;
  const nik=document.getElementById("NIK Pemohon").value||"temp";

  if(!rusun||!tipe||!lantai) return;

  msg.className="text-yellow-400";
  msg.innerText="Mengecek ketersediaan unit...";

  try{

    const r=await fetch(
      URL+"?action=get_unit"
      +"&rusun="+encodeURIComponent(rusun)
      +"&tipe="+encodeURIComponent(tipe)
      +"&lantai="+encodeURIComponent(lantai)
      +"&nik="+encodeURIComponent(nik)
    );

    const j=await r.json();

    if(j.waiting){
      _unit="";
      _token="";
      msg.className="text-red-400";
      msg.innerText="Unit penuh — masuk daftar tunggu";
      return;
    }

    _unit=j.unit;
    _token=j.token;

    msg.className="text-green-400";
    msg.innerText="Unit tersedia: "+_unit;

  }catch{
    msg.className="text-red-400";
    msg.innerText="Gagal cek unit";
  }
}
  
/* ===== TOGGLE PASAL ===== */
function togglePasal(){
  document.querySelectorAll(".pasalItem")
    .forEach(box => box.classList.toggle("hidden"));
}

/* ================= INTRO ================= */
const agree1=document.getElementById("agree1");
const agree2=document.getElementById("agree2");
const btnIntroNext=document.getElementById("btnIntroNext");

function checkAgree(){
btnIntroNext.disabled=!(agree1.checked&&agree2.checked);
}
agree1.onchange=checkAgree;
agree2.onchange=checkAgree;

btnIntroNext.onclick=()=>{
document.getElementById("introPage").style.display="none";
document.getElementById("formWrapper").style.display="block";
};

/* ================= TANGGAL + JAM + HARI ================= */
const tglInput=document.getElementById("Tanggal Formulir");
const now=new Date();
const yyyy=now.getFullYear();
const mm=String(now.getMonth()+1).padStart(2,"0");
const dd=String(now.getDate()).padStart(2,"0");
tglInput.value=`${yyyy}-${mm}-${dd}`;
tglInput.readOnly=true;

/* blok sabtu minggu */
//const day=now.getDay();
if(day===0||day===6){
lockForm("Pelayanan tidak beroperasi pada hari libur nasional dan hari besar keagamaan");
}

/* lock jam WIB 08:00-16:00 */
//const jam=now.getHours();
if(jam<8||jam>=16){
lockForm("Pendaftaran: 08:00 - 16:00 WITA");
}

function lockForm(text){
msg.className="text-red-400";
msg.innerText=text;
document.getElementById("next").disabled=true;
}

/* ================= PAGINATION ================= */
function showPage(){
pages.forEach((p,i)=>p.classList.toggle("hidden",i!==page));
prev.style.visibility=page===0?"hidden":"visible";
next.innerText=page===pages.length-1?"KIRIM":"Lanjut";
}
showPage();

function validatePage(){
const inputs=pages[page].querySelectorAll("input,textarea,select");

const optionalIds = [
  "Nama Perusahaan/Tempat Kerja 2",
  "Alamat Pekerjaan Pasangan",
  "Penghasilan perbulan Pasangan"
];

for(const x of inputs){

  x.classList.remove("err");

  if(x.classList.contains("hp")) continue;

  /* skip field opsional */
  if(optionalIds.includes(x.id)) continue;

  if(!x.value || !x.value.trim()){
    msg.innerText="Field belum diisi: " + x.id;
    msg.className="text-red-400";

    x.scrollIntoView({behavior:"smooth",block:"center"});
    x.focus();
    x.classList.add("err");

    return false;
  }
}

/* VALIDASI NIK 16 DIGIT */
const nik=document.getElementById("NIK Pemohon");
if(nik && page===1){
  if(!/^[0-9]+$/.test(nik.value)){
    msg.innerText="NIK harus angka";
    msg.className="text-red-400";
    nik.scrollIntoView({behavior:"smooth",block:"center"});
    nik.focus();
    nik.classList.add("err");
    return false;
  }
}

/* VALIDASI ANGKA PENGHASILAN (ANTI HURUF) */
const fieldsAngka = [
  "Penghasilan perbulan",
  "Penghasilan perbulan Pasangan"
];

for(const id of fieldsAngka){
  const el=document.getElementById(id);
  if(!el) continue;

  if(!el.value) continue; // kosong boleh jika opsional

  if(!/^[0-9]+$/.test(el.value)){
    msg.innerText="Field harus angka: " + id;
    msg.className="text-red-400";
    el.scrollIntoView({behavior:"smooth",block:"center"});
    el.focus();
    el.classList.add("err");
    return false;
  }
}

msg.innerText="";
return true;
}

function nextPage(){
  if(!validatePage())return;
  if(page<pages.length-1){page++;showPage();}
  else kirim();
}

function prevPage(){
if(page>0){page--;showPage();}
}

/* ================= SUBMIT ================= */
async function kirim(){

/* anti spam cooldown 10 detik */
if(Date.now()-lastSubmit<10000){
msg.className="text-red-400";
msg.innerText="Tunggu beberapa detik sebelum kirim lagi";
return;
}

/* honeypot bot */
const hp=document.getElementById("website");
if(hp && hp.value && hp.value.trim()!==""){
  msg.className="text-red-400";
  msg.innerText="Aktivitas tidak valid terdeteksi";
  return;
}


if(!validatePage())return;

if(!_unit || !_token){
  msg.className="text-red-400";
  msg.innerText="Pilih unit terlebih dahulu";
  return;
}

lastSubmit=Date.now();
next.disabled=true;
msg.innerText="Mengirim...";

const data={};
document.querySelectorAll("input,textarea,select").forEach(x=>{
if(x.id&&!x.classList.contains("hp"))data[x.id]=x.value;
});

/* ===== RECAPTCHA TOKEN ===== */
let captchaToken="";

try{
  await new Promise(r=>grecaptcha.ready(r));

  captchaToken = await grecaptcha.execute(
    "6LctlGQsAAAAANCxu-nYP1AxckjL--7GeEC_WE8r",
    {action:"submit"}
  );
}catch(e){
  msg.className="text-red-400";
  msg.innerText="Captcha gagal. Refresh halaman.";
  next.disabled=false;
  return;
}

/* kirim token */
data._captcha=captchaToken;
data._unit=_unit;
data._token=_token;

try{
const r=await fetch(URL+"?action=daftar",{
method:"POST",
body:JSON.stringify(data)
});
const j=await r.json();

if(j.status){
msg.className="text-green-400";
msg.innerText="Pendaftaran berhasil. No: "+j.no;
document.querySelectorAll("input,textarea,select").forEach(x=>x.value="");
page=0;showPage();
}else{
msg.className="text-red-400";
msg.innerText=j.message||"Gagal";
}
}catch{
msg.className="text-red-400";
msg.innerText="Server tidak merespon";
}

next.disabled=false;
}

</script>

</body>
</html>
