<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Tracking Verifikasi</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 text-white min-h-screen flex items-center justify-center p-3">

<div class="w-full max-w-2xl bg-slate-900/90 backdrop-blur border border-slate-800 rounded-2xl shadow-xl p-5">

<h1 class="text-2xl font-bold text-center mb-1">Tracking Pendaftaran Rusunawa</h1>
<p class="text-center text-slate-400 text-sm mb-5">Pantau status verifikasi pendaftaran Anda</p>

<div class="flex gap-2 mb-4">
  <input id="nik" type="text" placeholder="Masukkan 6 digit terakhir NIK / no HP / No Pendaftaran"
  class="w-full p-3 rounded-xl bg-slate-800 border border-slate-700 focus:ring focus:ring-blue-600">
  <button onclick="cek()" class="bg-blue-600 px-5 rounded-xl font-semibold hover:bg-blue-700">Cek</button>
</div>

<!-- STATUS BOX -->
<div id="statusBox" class="hidden mb-4 p-3 rounded-xl text-center font-bold text-lg"></div>

<div id="hasil" class="hidden"></div>
<div id="msg" class="text-center text-red-400 text-sm mt-3"></div>

<a id="linkLanjut"
   href="https://docs.google.com/forms/d/e/1FAIpQLSf2LjzX-sbv3ZtGic3nz4ptqBChoTB6Zho0WR3s9_2CpnvAIA/closedform"
   target="_blank"
   class="hidden block mt-3 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-xl text-center">
   Lanjut ke Tahap Berikutnya
</a>

</div>

<script>
const API="https://script.google.com/macros/s/AKfycbySr6QhyH72b4aAU6Xv6mltljm_ft07ysWb40J45QivoXYix8Xh9M1kJ8zLe4PzQ5i8/exec";

/* ===== AUTO LOAD FROM LINK ===== */
window.addEventListener("load",()=>{
  const p=new URLSearchParams(location.search);
  const n=p.get("nik");
  if(n){
    nik.value=n;
    cek();
  }
});

/* ===== MASKING NIK ===== */
function maskNik(n){
  if(!n) return "";
  n=String(n);
  if(n.length<8) return n;
  return n.slice(0,4)+"********"+n.slice(-4);
}

/* ===== STATUS BOX ===== */
function setStatusBox(status){

  statusBox.className="mb-4 p-3 rounded-xl text-center font-bold text-lg";
  status=(status||"").toUpperCase();

  if(status.includes("DITERIMA")){
    statusBox.textContent="STATUS : DITERIMA";
    statusBox.classList.add("bg-green-600");
    showNextLink(true);

  }else if(status.includes("DITOLAK")){
    statusBox.textContent="STATUS : DITOLAK";
    statusBox.classList.add("bg-red-600");
    showNextLink(false);

  }else if(status.includes("DIPROSES")){
    statusBox.textContent="STATUS : DIPROSES";
    statusBox.classList.add("bg-amber-500","text-black");
    showNextLink(false);

  }else if(status.includes("VERIFIKASI")){
    statusBox.textContent="STATUS : VERIFIKASI";
    statusBox.classList.add("bg-yellow-500","text-black");
    showNextLink(false);

  }else{
    statusBox.textContent="STATUS : MENUNGGU";
    statusBox.classList.add("bg-blue-600");
    showNextLink(false);
  }

  statusBox.classList.remove("hidden");
}

/* ===== FETCH ===== */
async function cek(){

  const nikVal=nik.value.trim();
  hasil.classList.add("hidden");
  statusBox.classList.add("hidden");
  showNextLink(false);
  msg.textContent="Memuat data...";

  if(!nikVal){
    msg.textContent="NIK wajib diisi";
    return;
  }

  try{
    const r=await fetch(API+"?action=track&q="+encodeURIComponent(nikVal));
    const j=await r.json();

    if(!j.status){
      msg.textContent=j.message||"Data tidak ditemukan";
      return;
    }

    msg.textContent="";
    setStatusBox(j.verifikasi);
    renderUI(j);
    hasil.classList.remove("hidden");

  }catch{
    msg.textContent="Server tidak merespon";
  }
}

/* ===== UI CARD ===== */
function block(label,val){
  if(!val || val==="-" ) return "";
  return `<div><b class="text-blue-400">${label}</b><br>${val}</div>`;
}

function renderUI(d){

  hasil.innerHTML=`
  <div class="bg-slate-800 rounded-xl p-4 space-y-2">

    ${block("Nama Pemohon",d.nama)}
    ${block("NIK",maskNik(d.nik))}
    ${block("Rusunawa",d.rusun)}
    ${block("Tipe Kamar",d.tipe)}
    ${block("Lantai",d.lantai)}

    <hr class="border-slate-700 my-2">

    ${block("Status Verifikasi",d.verifikasi)}
    ${block("Catatan Verifikasi",d.catatan || "-")}
    ${block("Tanggal Verifikasi",d.tanggal)}
    ${block("No Pendaftaran",d.no)}

    <button onclick="downloadBukti()" 
    class="mt-3 bg-emerald-600 px-4 py-2 rounded-xl font-semibold w-full">
    â¬‡ Download Bukti Pendaftaran
    </button>

  </div>`;

  window._data=d;
}

function maskHP(hp){
  if(!hp) return "";
  const s = String(hp).replace(/\D/g,"");
  if(s.length <= 6) return s;
  return s.slice(0,2) + "******" + s.slice(-2);
}

/* ===== DOWNLOAD BUKTI ===== */
function downloadBukti(){

  if(!window._data) return;

  let t="BUKTI PENDAFTARAN RUSUNAWA\n\n";

  t+="Nama : "+(_data.nama||"")+"\n";
  t+="NIK  : "+maskNik(_data.nik)+"\n";
  t+="Pekerjaan : "+(_data.pekerjaan||"-")+"\n";
  t+="Status Kependudukan : "+(_data.status_kependudukan||"-")+"\n";
  t+="Umur : "+(_data.umur||"-")+"\n";
  t+="Status Perkawinan : "+(_data.status_perkawinan||"-")+"\n";
  t+="Jumlah Anggota Keluarga : "+(_data.anggota||"-")+"\n";
  t+="Nomor HP/WA : "+maskHP(_data.hp||"-")+"\n";

  t+="\n";
  t+="Rusun : "+(_data.rusun||"")+"\n";
  t+="Tipe : "+(_data.tipe||"")+"\n";
  t+="Lantai : "+(_data.lantai||"")+"\n";

  t+="\n";
  t+="Status : "+(_data.verifikasi||"")+"\n";
  t+="Tanggal Verifikasi : "+(_data.tanggal||"")+"\n";
  t+="Catatan : "+(_data.catatan||"")+"\n";
  t+="No Pendaftaran : "+(_data.no||"")+"\n";

  const blob=new Blob([t],{type:"text/plain"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="Bukti_Pendaftaran.txt";
  a.click();
}

function showNextLink(show){
  const el = document.getElementById("linkLanjut");
  if(!el) return;
  el.classList.toggle("hidden", !show);
}

/* ENTER = CEK */
nik.addEventListener("keydown",e=>{
  if(e.key==="Enter") cek();
});
</script>
</body>
</html>


