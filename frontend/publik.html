<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Data Publik Pendaftaran Rusunawa</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>
<script src="config.js"></script>
</head>

<body class="bg-slate-950 text-white min-h-screen">

<!-- HEADER -->
<div class="bg-slate-900 border-b border-slate-800 p-3 text-center font-semibold">
Data Publik Pendaftaran Rusunawa
</div>

<div class="max-w-7xl mx-auto p-4 space-y-4">

<!-- FILTER -->
<div class="flex flex-wrap gap-2">
<input id="cari" placeholder="Cari nama / rusun / status"
class="bg-slate-900 border border-slate-700 rounded p-2 text-sm flex-1">

<select id="filterStatus" class="bg-slate-900 border border-slate-700 rounded p-2 text-sm">
<option value="">Semua Status</option>
<option>MENUNGGU</option>
<option>DITERIMA</option>
<option>DITOLAK</option>
<option>WAITING</option>
</select>
</div>

<!-- TABLE -->
<div class="bg-slate-900 border border-slate-800 rounded-xl overflow-auto">
<table class="w-full text-sm" id="table"></table>
</div>

</div>

<script>
const API = CONFIG.API;

let DATA=[];

function fmtTanggal(x){
  if(!x) return "";
  const d=new Date(x);
  if(isNaN(d)) return x;
  return d.toLocaleDateString("id-ID")+" "+
         d.toLocaleTimeString("id-ID",{hour:"2-digit",minute:"2-digit"});
}

/* ===== SENSOR NOMOR ===== */
function sensorHP(no){
  if(!no) return "";
  no=String(no);
  if(no.length<=6) return no;
  return no.slice(0,4)+"****"+no.slice(-2);
}

/* ===== LOAD DATA ===== */
async function load(){
  const r = await fetch(API+"?action=daftar_all&key=public");
  const j = await r.json();

  if(!j.data) return;

  DATA = j.data.map(row=>{
  return {
    tanggal: row[0],
    nama: row[1],
    hp: sensorHP(row[9]),
    kerja: row[12],
    rusun: row[24],
    tipe: row[25],
    lantai: row[26],
    status: row[27],
    catatan: row[28],
    tglver: row[29]
  };
});
  render();
}

/* ===== RENDER ===== */
function render(){
  const q=cari.value.toLowerCase();
  const fs=filterStatus.value;

  const d=DATA.filter(x=>{
    if(fs && x.status!==fs) return false;
    if(!q) return true;
    return (
      x.nama.toLowerCase().includes(q) ||
      x.rusun.toLowerCase().includes(q) ||
      x.status.toLowerCase().includes(q)
    );
  });

  let h=`<tr class="bg-slate-800">
  <th class="p-2 border">Tanggal</th>
  <th class="p-2 border">Nama</th>
  <th class="p-2 border">No HP</th>
  <th class="p-2 border">Pekerjaan</th>
  <th class="p-2 border">Rusunawa</th>
  <th class="p-2 border">Tipe</th>
  <th class="p-2 border">Lantai</th>
  <th class="p-2 border">Status</th>
  <th class="p-2 border">Catatan</th>
  <th class="p-2 border">Tgl Verifikasi</th>
  </tr>`;

  d.forEach(r=>{
    let warna="text-yellow-400";
    if(r.status==="DITERIMA") warna="text-green-400";
    if(r.status==="DITOLAK") warna="text-red-400";

    h+=`<tr class="hover:bg-slate-800">
    <td class="p-2 border">${fmtTanggal(r.tanggal)}</td>
    <td class="p-2 border">${r.nama||""}</td>
    <td class="p-2 border">${r.hp||""}</td>
    <td class="p-2 border">${r.kerja||""}</td>
    <td class="p-2 border">${r.rusun||""}</td>
    <td class="p-2 border">${r.tipe||""}</td>
    <td class="p-2 border">${r.lantai||""}</td>
    <td class="p-2 border font-bold ${warna}">${r.status||""}</td>
    <td class="p-2 border">${r.catatan||""}</td>
    <td class="p-2 border">${fmtTanggal(r.tglver)}</td>
    </tr>`;
  });

  table.innerHTML=h;
}

cari.oninput=render;
filterStatus.onchange=render;

load();
</script>

</body>
</html>
