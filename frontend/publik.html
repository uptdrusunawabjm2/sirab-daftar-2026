<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Daftar Permohonan</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>
<script src="config.js"></script>

<style>
/* ===== STICKY HEADER TABLE ===== */
#table th{
  position: sticky;
  top: 0;
  z-index: 20;          /* lebih tinggi agar tidak tertutup */
  background: #1e293b;  /* wajib solid, jangan transparan */
}

/* shadow tipis agar terlihat mengambang saat scroll */
#table th{
  box-shadow: 0 2px 0 rgba(0,0,0,.5);
}

select {
  background-color: #0f172a;
  color: white;
}

select option {
  color: black;
}

</style>
<meta name="robots" content="noindex,nofollow">
</head>

<body class="bg-slate-950 text-white min-h-screen">

<!-- HEADER -->
<div class="bg-slate-900 border-b border-slate-800 p-3 text-center font-semibold">
Daftar Permohonan Rusunawa
</div>

<div class="max-w-7xl mx-auto p-4 space-y-4">

<!-- FILTER -->
<div class="flex flex-wrap gap-2">
<input id="cari" placeholder="Cari nama / rusun / status"
class="bg-slate-900 border border-slate-700 rounded p-2 text-sm flex-1">

<select id="filterStatus">
  <option value="" style="color:black;">Semua Status</option>
  <option value="DIPROSES" style="color:black;">DIPROSES</option>
  <option value="DITERIMA" style="color:black;">DITERIMA</option>
  <option value="DITOLAK" style="color:black;">DITOLAK</option>
</select>
</div>

<!-- TABLE -->
<div class="bg-slate-900 border border-slate-800 rounded-xl overflow-auto max-h-[70vh]">
<table class="w-full text-sm" id="table"></table>
</div>


<script>
const API = CONFIG.API;

let DATA=[];

function fmtTanggal(x){
  if(!x) return "";

  const d = new Date(x);
  if(isNaN(d)) return x;

  const bulan = [
    "Januari","Februari","Maret","April","Mei","Juni",
    "Juli","Agustus","September","Oktober","November","Desember"
  ];

  return d.getDate() + " " +
         bulan[d.getMonth()] + " " +
         d.getFullYear();
}


/* ===== SENSOR NOMOR ===== */
function sensorHP(no){
  if(!no) return "";
  no=String(no);
  if(no.length<=6) return no;
  return no.slice(0,4)+"****"+no.slice(-2);
}

/* ===== LOAD DATA ===== */
async function load(){
  const r = await fetch(API+"?action=daftar_all&key=public");
  const j = await r.json();

  if(!j.data) return;

DATA = j.data.map(row=>{
  return {
    tanggal: row[0],
    nama: row[1],
    nik: row[2],
    kependudukan: row[3],
    umur: row[4],
    agama: row[5],
    kawin: row[6],
    alamat: row[7],
    tinggal: row[8],
    hp: row[9],
    anggota: row[10],
    email: row[11],
    kerja: row[12],
    rusun: row[24],
    tipe: row[25],
    lantai: row[26],
    status: row[27],
    catatan: row[28],
    tglver: row[29]
  };
});
  render();
}

/* ===== RENDER ===== */
function render(){
  const q=cari.value.toLowerCase();
  const fs=filterStatus.value;

  const d=DATA.filter(x=>{
    if(fs && String(x.status||"").trim().toUpperCase() !== fs.trim().toUpperCase())
  return false;
    if(!q) return true;
    return (
      x.nama.toLowerCase().includes(q) ||
      x.rusun.toLowerCase().includes(q) ||
      x.status.toLowerCase().includes(q)
    );
  });

  let h=`<tr class="bg-slate-800">
      <th class="p-2 border">Tanggal Formulir</th>
      <th class="p-2 border">Nama Pemohon</th>
      <th class="p-2 border">NIK</th>
      <th class="p-2 border">Status Kependudukan</th>
      <th class="p-2 border">Umur</th>
      <th class="p-2 border">Agama</th>
      <th class="p-2 border">Status Perkawinan</th>
      <th class="p-2 border">Alamat Sekarang</th>
      <th class="p-2 border">Status Tempat Tinggal</th>
      <th class="p-2 border">No HP</th>
      <th class="p-2 border">Jumlah Anggota</th>
      <th class="p-2 border">Email</th>
      <th class="p-2 border">Pekerjaan</th>
      <th class="p-2 border">Rusunawa</th>
      <th class="p-2 border">Tipe</th>
      <th class="p-2 border">Lantai</th>
      <th class="p-2 border">Status</th>
      <th class="p-2 border">Catatan</th>
      <th class="p-2 border">Tgl Verifikasi</th>
      </tr>`;

  d.forEach(r=>{
    let warna="text-blue-400";
    if(r.status==="VERIFIKASI") warna="text-yellow-400";
    else if(r.status==="DIPROSES") warna="text-amber-400";
    else if(r.status==="DITERIMA") warna="text-green-400";
    else if(r.status==="DITOLAK") warna="text-red-400";

    h+=`<tr class="hover:bg-slate-800">
      <td class="p-2 border">${fmtTanggal(r.tanggal)}</td>
      <td class="p-2 border">${r.nama||""}</td>
      <td class="p-2 border">${r.nik||""}</td>
      <td class="p-2 border">${r.kependudukan||""}</td>
      <td class="p-2 border">${r.umur||""}</td>
      <td class="p-2 border">${r.agama||""}</td>
      <td class="p-2 border">${r.kawin||""}</td>
      <td class="p-2 border">${r.alamat||""}</td>
      <td class="p-2 border">${r.tinggal||""}</td>
      <td class="p-2 border">${r.hp||""}</td>
      <td class="p-2 border">${r.anggota||""}</td>
      <td class="p-2 border">${r.email||""}</td>
      <td class="p-2 border">${r.kerja||""}</td>
      <td class="p-2 border">${r.rusun||""}</td>
      <td class="p-2 border">${r.tipe||""}</td>
      <td class="p-2 border">${r.lantai||""}</td>
      <td class="p-2 border font-bold ${warna}">${r.status||""}</td>
      <td class="p-2 border">${r.catatan||""}</td>
      <td class="p-2 border">${fmtTanggal(r.tglver)}</td>
      </tr>';
  });

  table.innerHTML=h;
}

cari.oninput=render;
filterStatus.onchange=render;

load();
</script>

</body>
</html>
