<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Daftar Permohonan</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>
<script src="config.js"></script>

<style>
/* ===== STICKY HEADER TABLE ===== */
#table th{
  position: sticky;
  top: 0;
  z-index: 20;
  background: #1e293b;
  box-shadow: 0 2px 0 rgba(0,0,0,.5);
}

/* ===== TABLE FIT SCREEN ===== */
#table{
  table-layout: fixed;
  width: 100%;
  font-size: 12px;
}

#table th,
#table td{
  white-space: normal;
  word-break: break-word;
  padding: 6px;
  vertical-align: top;
}

/* ===== MOBILE RESPONSIVE ===== */
@media (max-width: 768px){

  #table thead{
    display:none;
  }

  #table tr{
    display:block;
    margin-bottom:12px;
    border:1px solid #334155;
    border-radius:8px;
    background:#0f172a;
    padding:10px;
  }

  #table td{
    display:flex;
    justify-content:space-between;
    border:none !important;
    padding:4px 0;
    font-size:12px;
  }

  #table td::before{
    content: attr(data-label);
    font-weight:600;
    color:#94a3b8;
  }

  #table th{
    position:static;
    box-shadow:none;
  }
}

select{
  background:#0f172a;
  color:white;
}

/* ===== DESKTOP ROW BORDER ===== */
@media (min-width: 769px){

  #table{
    border-collapse: collapse;
  }

  #table th{
    border: 1px solid #334155;
  }

  #table td{
    border: 1px solid #334155;
  }

  #table tr:nth-child(even){
    background: #020617; /* zebra halus */
  }

  #table tr:hover{
    background: #0f172a;
  }
}
</style>
<meta name="robots" content="noindex,nofollow">
</head>

<body class="bg-slate-950 text-white min-h-screen">

<div class="bg-slate-900 border-b border-slate-800 p-3 text-center font-semibold">
Daftar Permohonan Rusunawa
</div>

<div class="max-w-7xl mx-auto p-4 space-y-4">

<!-- FILTER -->
<!-- FILTER -->
<div class="flex flex-wrap md:flex-nowrap items-center gap-2">

<input id="cari" placeholder="Cari nama / rusun / status"
class="bg-slate-900 border border-slate-700 rounded p-2 text-sm flex-1 min-w-[200px]">

<select id="filterStatus"
class="p-2 text-sm min-w-[150px]">
  <option value="">Semua Status</option>
  <option value="DIPROSES">DIPROSES</option>
  <option value="DITERIMA">DITERIMA</option>
  <option value="DITOLAK">DITOLAK</option>
</select>

<select id="sortTanggal"
class="p-2 text-sm min-w-[170px]">
  <option value="desc">Tanggal Terbaru</option>
  <option value="asc">Tanggal Terlama</option>
</select>

</div>

<!-- TABLE -->
<div class="bg-slate-900 border border-slate-800 rounded-xl overflow-y-auto max-h-[75vh]">
<table class="w-full text-xs" id="table"></table>
</div>

<script>
const API = CONFIG.API;
let DATA=[];

function fmtTanggal(x){
  if(!x) return "";
  const d = new Date(x);
  if(isNaN(d)) return x;

  const bulan=[
  "Januari","Februari","Maret","April","Mei","Juni",
  "Juli","Agustus","September","Oktober","November","Desember"];

  return d.getDate()+" "+bulan[d.getMonth()]+" "+d.getFullYear();
}

async function load(){
  const r = await fetch(API+"?action=daftar_all&key=public");
  const j = await r.json();
  if(!j.data) return;

  DATA = j.data.map(row=>{
    return {
      tanggal: row[0],
      nama: row[1],
      nik: row[2],
      kependudukan: row[3],
      umur: row[4],
      kawin: row[5],
      tinggal: row[6],
      hp: row[7],
      anggota: row[8],
      kerja: row[9],
      rusun: row[10],
      tipe: row[11],
      lantai: row[12],
      status: row[13],
      catatan: row[14],
      tglver: row[15]
    };
  });

  render();
}

function render(){

  const q=cari.value.toLowerCase();
  const fs=filterStatus.value;

  const d=DATA.filter(x=>{
    if(fs && (x.status||"").toUpperCase()!==fs) return false;
    if(!q) return true;

    return (
      (x.nama||"").toLowerCase().includes(q) ||
      (x.rusun||"").toLowerCase().includes(q) ||
      (x.status||"").toLowerCase().includes(q)
    );
  });

  // ===== SORTIR BERDASARKAN TANGGAL =====
const mode = sortTanggal.value || "desc";

d.sort((a,b)=>{
  const ta = new Date(a.tanggal || 0).getTime();
  const tb = new Date(b.tanggal || 0).getTime();
  return mode==="asc" ? ta - tb : tb - ta;
});

  let h=`
  <thead>
  <tr class="bg-slate-800">
  <th>Tanggal</th>
  <th>Nama</th>
  <th>NIK</th>
  <th>Kependudukan</th>
  <th>Umur</th>
  <th>Status Kawin</th>
  <th>Status Tinggal</th>
  <th>No HP</th>
  <th>Anggota</th>
  <th>Pekerjaan</th>
  <th>Rusun</th>
  <th>Tipe</th>
  <th>Lantai</th>
  <th>Status</th>
  <th>Catatan</th>
  <th>Tgl Verifikasi</th>
  </tr>
  </thead>
  <tbody>
  `;

  d.forEach(r=>{

    let warna="text-blue-400";
    if(r.status==="DIPROSES") warna="text-amber-400";
    else if(r.status==="DITERIMA") warna="text-green-400";
    else if(r.status==="DITOLAK") warna="text-red-400";

    h+=`
    <tr class="hover:bg-slate-800">
      <td data-label="Tanggal">${fmtTanggal(r.tanggal)}</td>
      <td data-label="Nama">${r.nama||""}</td>
      <td data-label="NIK">${r.nik||""}</td>
      <td data-label="Kependudukan">${r.kependudukan||""}</td>
      <td data-label="Umur">${r.umur||""}</td>
      <td data-label="Status Kawin">${r.kawin||""}</td>
      <td data-label="Status Tinggal">${r.tinggal||""}</td>
      <td data-label="No HP">${r.hp||""}</td>
      <td data-label="Anggota">${r.anggota||""}</td>
      <td data-label="Pekerjaan">${r.kerja||""}</td>
      <td data-label="Rusun">${r.rusun||""}</td>
      <td data-label="Tipe">${r.tipe||""}</td>
      <td data-label="Lantai">${r.lantai||""}</td>
      <td data-label="Status" class="font-bold ${warna}">${r.status||""}</td>
      <td data-label="Catatan">${r.catatan||""}</td>
      <td data-label="Tgl Verifikasi">${fmtTanggal(r.tglver)}</td>
    </tr>
    `;
  });

  h+="</tbody>";
  table.innerHTML=h;
}

cari.oninput=render;
filterStatus.onchange=render;
sortTanggal.onchange=render;

load();
</script>

</body>
</html>
